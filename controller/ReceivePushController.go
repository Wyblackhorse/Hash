/**
 * @Author $
 * @Description //TODO $
 * @Date $ $
 * @Param $
 * @return $
 **/
package controller

import (
	"encoding/json"
	"fmt"
	"github.com/gin-gonic/gin"
	"github.com/shopspring/decimal"
	"github.com/spf13/viper"
	"github.com/wangyi/MgHash/dao/mysql"
	"github.com/wangyi/MgHash/dao/redis"
	"github.com/wangyi/MgHash/model"
	"github.com/wangyi/MgHash/tools"
	"github.com/wangyi/MgHash/util"
	"go.uber.org/zap"
	"io/ioutil"
	"math/big"
	"net/http"
	"strconv"
	"time"
)

func NotificationTelegram(Message string) {
	TelegramToken := ":" //token
	TelegramChatId := "" //èŠå¤©id
	url := "https://api.telegram.org/bot" + TelegramToken + "/sendMessage?chat_id=" + TelegramChatId + "&text=" + Message
	_, err := http.Get(url)
	if err != nil {
		fmt.Println(err.Error())
		return
	}
}

func ToDecimal(ivalue interface{}, decimals int) decimal.Decimal {
	value := new(big.Int)
	switch v := ivalue.(type) {
	case string:
		value.SetString(v, 10)
	case *big.Int:
		value = v
	}

	mul := decimal.NewFromFloat(float64(10)).Pow(decimal.NewFromFloat(float64(decimals)))
	num, _ := decimal.NewFromString(value.String())
	result := num.Div(mul)

	return result
}

type AutoGenerated struct {
	Game string `json:"game"`
	Tx   struct {
		TxHash      string `json:"txHash"`
		BlockNumber int    `json:"blockNumber"`
		BlockHash   string `json:"blockHash"`
		Timestamp   int64  `json:"timestamp"`
		From        string `json:"from"`
		To          string `json:"to"`
		Amount      int    `json:"amount"`
		Token       string `json:"token"`
		Win         int    `json:"win"`
		Status      int    `json:"status"`
		Bonus       int    `json:"bonus"`
		SettleTx    string `json:"settleTx"`
		WagerType   string `json:"wagerType"`
		LotteryType string `json:"lotteryType"`
	} `json:"tx"`
}

/**
æ¨é€
*/
func ReceivePush(ctx *gin.Context) {
	data, _ := ioutil.ReadAll(ctx.Request.Body)
	//fmt.Printf(string(data))
	zap.L().Debug(string(data))
	var mobile AutoGenerated
	err := json.Unmarshal(data, &mobile)
	if err != nil {
		util.JsonWrite(ctx, -101, nil, err.Error())
		return
	}

	//-1:æŠ•æ³¨æ— æ•ˆ, 0:è¾“, 1:èµ¢
	var win string
	status := 0
	if mobile.Tx.Win == -1 {
		win = "æŠ•æ³¨æ— æ•ˆ"
		status = 3
	} else if mobile.Tx.Win == 0 {
		win = "è¾“"
		status = 1
	} else if mobile.Tx.Win == 1 {
		win = "èµ¢"
		status = 2
	} else if mobile.Tx.Win == 2 {
		win = "å¹³"
		status = 6
	}
	//æŠ•æ³¨é‡‘é¢			  /1000000
	acc := strconv.Itoa(mobile.Tx.Amount)
	account := ToDecimal(acc, 6).String()
	Bonus := strconv.Itoa(mobile.Tx.Bonus)
	bcc := ToDecimal(Bonus, 6).String()
	//PP, _ := util.ToDecimal(amount, 6).Float64()
	BlockNumber := strconv.Itoa(mobile.Tx.BlockNumber)

	var Tx4 string
	if len(mobile.Tx.From) == 34 {
		Tx := mobile.Tx.From
		Tx2 := Tx[:3]
		Tx3 := Tx[len(Tx)-3:]
		Tx4 = Tx2 + "********************" + Tx3
	} else {
		Tx4 = mobile.Tx.From
	}

	lickGame := mobile.Game
	if mobile.Game == "å°¾æ•°" {
		lickGame = "å¹¸è¿"
	}

	message := "ğŸ†ç©å®¶åœ°å€ï¼š" + Tx4 + "%0A" +
		"ğŸ²åŒºå—å“ˆå¸Œï¼ˆBLock hashï¼‰å¼€å¥–ç»“æœ:" + mobile.Tx.BlockHash + "%0A" +
		"åŒºå—å·:" + BlockNumber + "%0A" +
		"ğŸ’¹èµ„äº§ç±»å‹ï¼š" + mobile.Tx.Token + "%0A" +
		"ğŸ°æ¸¸æˆç±»å‹ï¼š" + lickGame + "%0A" +
		"ğŸ…å¼€å¥–çŠ¶æ€ï¼š" + win + "%0A" +
		"ğŸ’°æŠ•æ³¨é‡‘é¢ï¼š" + account + "%0A" +
		"æŠ•æ³¨åœ°å€:" + mobile.Tx.To + "%0A" +
		"å¥–äº¤æ˜“å“ˆå¸Œ:" + mobile.Tx.SettleTx + "%0A" +
		"ğŸ’µå‘æ”¾é‡‘é¢ï¼š" + bcc + "%0A" + "%0A" +
		"åº„å®¶å¼€å¥–ç»“æœ:" + mobile.Tx.LotteryType + "%0A" +
		"ç©å®¶å¼€å¥–ç»“æœ:" + mobile.Tx.WagerType + "%0A" +
		"æ¬¢è¿å¤§å®¶åŠ å…¥å®˜æ–¹äº¤æµç¾¤ï¼Œæ¯å¤©æ™šä¸Šç¦åˆ©é€ä¸åœï¼Œé‡è¦çš„è¯è¯´ä¸‰éï¼Œè¿”æ°´è¿”æ°´è¿”æ°´åªåœ¨äº¤æµç¾¤å‘æ”¾"
	go NotificationTelegram(message)
	//æ·»åŠ åˆ°æ•°æ®åº“
	BlockNum := strconv.Itoa(mobile.Tx.BlockNumber)
	money, _ := ToDecimal(acc, 6).Float64()
	bet := money
	if mobile.Game == "ç‰›ç‰›" {
		bet = money / 10
	}
	BackMoney, _ := ToDecimal(Bonus, 6).Float64()
	//æ˜¯å¦æ´¾å‘   1 å·²ç»æ´¾å‘ 2æ— éœ€æ´¾å‘ 3æ²¡æœ‰æ´¾å‘  4æ´¾å‘å¤±è´¥
	Distribute := 1
	if BackMoney > 0 && mobile.Tx.BlockHash == "" {
		Distribute = 3
	}
	if BackMoney == 0 {
		Distribute = 2
	}
	if mobile.Tx.Status == 11 {
		Distribute = 4
	}
	tm := time.Unix(mobile.Tx.Timestamp/1000, 0)
	date := tm.Format("2006-01-02")
	add := model.TransactionRecordModel{
		ToAddress:      mobile.Tx.To,
		Form:           mobile.Tx.From,
		BlockHash:      mobile.Tx.BlockHash,
		TransactionId:  mobile.Tx.TxHash,
		Symbol:         mobile.Tx.Token,
		BetName:        mobile.Game,
		Status:         status, ////çŠ¶æ€ 1è¾“  2 èµ¢ 3æ— æ•ˆ  6 å’Œ
		BlockNum:       BlockNum,
		BlockTimestamp: mobile.Tx.Timestamp,
		Money:          money,
		Bet:            bet,
		BankerResult:   mobile.Tx.LotteryType,
		PlayerResult:   mobile.Tx.WagerType,
		BackMoney:      BackMoney,
		Result:         BackMoney - money,
		Created:        time.Now().Unix(),
		Updated:        time.Now().Unix(),
		Distribute:     Distribute,
		Date:           date,
		Week:           tools.ReturnTheWeek(),
		Month:          tools.ReturnTheMonth(),
	}
	err = mysql.DB.Where("transaction_id=?", add.TransactionId).First(&model.TransactionRecordModel{}).Error
	if err != nil { //æ²¡æœ‰é”™è¯¯  è¯´æ˜æ‰¾åˆ°äº†
		err = mysql.DB.Save(&add).Error
		if err == nil { //æ·»åŠ æˆåŠŸ
			redis.Rdb.Set("Myself_"+add.ToAddress, add.BlockTimestamp, 0) //å°†æœ€åä¸€æ¬¡çš„æ—¶é—´æˆ³
			//å…¥åº“æˆåŠŸ  é€šçŸ¥ç”¨æˆ·
			u := model.UserModel{Trc20Address: add.Form}
			Tid, err := u.ReturnTelegramId(mysql.DB)
			if err == nil {
				var strBool bool
				var filePath string
				var kinds string
				filePath = "real/" + strconv.FormatInt(Tid, 10) + "/" + time.Now().Format("20060112")
				kinds = mobile.Tx.BlockHash + ".png"
				if lickGame == "ç‰›ç‰›" {
					strBool = util.RealTimeSendResult("picture/Niu/back.jpg", util.NiuReturnImageUrl(mobile.Tx.WagerType, 1), util.NiuReturnImageUrl(mobile.Tx.LotteryType, 2), filePath, kinds)

				} else if lickGame == "å¹¸è¿" {
					if status == 1 {
						//è¾“
						strBool = util.RealTimeSendResult("picture/Luckly/back.jpg", "picture/Luckly/lose.png", "picture/Luckly/win.png", filePath, kinds)
					} else if status == 2 {
						//èµ¢
						strBool = util.RealTimeSendResult("picture/Luckly/back.jpg", "picture/Luckly/win.png", "picture/Luckly/win.png", filePath, kinds)
					}
				} else if lickGame == "å•åŒ" {
					pally, zJ := util.DsResultBetData(mobile.Tx.BlockHash, money)
					strBool = util.RealTimeSendResult("picture/singleOrDouble/back.jpg", util.DsReturnImageUrl(pally), util.DsReturnImageUrl(zJ), filePath, kinds)

				} else if lickGame == "ç™¾å®¶ä¹" {
					pally, zJ := util.BjlBetResultForTelegram(mobile.Tx.BlockHash)
					strBool = util.RealTimeSendResult("picture/Baccarat/back.jpg", "picture/Baccarat/player/"+pally+".png", "picture/Baccarat/banker/"+zJ+".png", filePath, kinds)

				}

				if strBool == true {
					if status != 3 {
						betString := strconv.FormatFloat(bet, 'f', 0, 64)
						backString := strconv.FormatFloat(BackMoney, 'f', 0, 64)
						tm := time.Unix(mobile.Tx.Timestamp/1000, 0)
						util.SendPhotoTo(viper.GetString("hash.HashToken"), Tid, filePath+"/"+kinds, status, lickGame, betString+mobile.Tx.Token, mobile.Tx.BlockHash, backString+mobile.Tx.Token, tm.Format("2006-01-02 15:04:05"))

					}

				}

			}

		}

	} else { //æ›´æ–°

	}
	util.JsonWrite(ctx, 200, nil, "æ‰§è¡ŒæˆåŠŸ")
	return
}
